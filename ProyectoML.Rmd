---
title: "Indicadores de salud para el corazón."
subtitle: "Modelos lineales. Grado en Ciencia de Datos- UV"
author: "Gema Bravo Aguilera, Sandra Paniagua Sanchez, Wilson Paul Portillo Barriga."
date:  "`r Sys.Date()`"  
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
output:
  html_document: default
  word_document: default
  pdf_document: default
---


```{r setup, cache = F,  message = F, warning = F, tidy = F, include=FALSE}
# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

opts_chunk$set(echo=F, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})

```

```{r, echo = FALSE, include=FALSE}

# Especificamos las librerías necesarias en esta lista

packages = c("tidyverse","knitr", "lubridate", "readr", "dplyr", "forcats", "lubridate", "magrittr", "stringr", "tibble", "tidyr", "datasets", "RColorBrewer","nycflights13", "base", "datasets", "ggplot2", "plotly", "highcharter")

package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

search()

```

\bigskip

\bigskip

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\bigskip

\tableofcontents

\bigskip

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}


\newpage



## 1. Introducción del trabajo

El objetivo de este trabajo es analizar los datos recogidos por 





# 1.1. Carga de datos

```{r}
data <- read_csv("data/heart_disease_health_indicators_BRFSS2015.csv")
```


# 1.2.Transformación de datos

En los datos cargados la variable Age toma valores numéricos (1 al 13) que en
verdad se corresponden con una variable factor donde se representan los grupos 
de edad. 

```{r}

datos <- data %>% 
  rename(Enfermedad_Cardiaca_Ataque = HeartDiseaseorAttack,
                         Fumador = Smoker, # 1 es si ha fumado 100 cigarros en toda su vida o si no 0
                         Verduras = Veggies, # 1 si consume verduras 1 o más veces por dia
                         Salud_Mental = MentHlth,
                         Educacion = Education,
                         Presion_Sanginea_Alta = HighBP,
                         Ataque = Stroke,
                         Consumo_Alcohol = HvyAlcoholConsump,  #Hombre + 14 bebidas alcholicas/semana (1)
                                                               #mujer + 7 bebidas alcholicas/semana (0)
                         Salud_Fisica = PhysHlth,
                         Ingreso = Income,
                         Colesterol_Alto = HighChol,
                         Cuidado_Salud = AnyHealthcare,
                         Dificultad_Andar = DiffWalk,
                         Control_Colesterol = CholCheck,
                         Actividad_Fisica = PhysActivity,
                         No_Doctor_Caro = NoDocbcCost,
                         Sexo = Sex, # mujer 0, hombre 1
                         IMC = BMI,
                         Frutas = Fruits, # 1 si consume frutas 1 o más veces por dia
                         Salud_General = GenHlth,
                         Edad = Age) # 13 categorias de edad

```


Hacemos un gráfico inicial para ver como se distribuyen los datos de las variables que creemos que pueden influir a la hora de tener una enfermedad cardiaca
```{r}
colores <- c("Hombre" = "#37a4d7",
             "Mujer" = "#9c3035")
datos2 <- datos 
datos2$Edad <- factor(datos2$Edad, levels=c(1,2,3,4,5,6,7,8,9,10,11,12,13),
                   labels= c("[18 a 24]", "[25 a 29]", "[30 a 34]", "[35 a 39]", "[40 a 44]", "[45 a 49]", "[50 a 54]", "[55 a 59]", "[60 a 64]", "[65 a 69]", "[70 a 74]", "[75 a 79]", "[80 o más]")) 

datos3 <- datos2 %>%
      group_by(Edad,Sexo) %>% 
      filter(Enfermedad_Cardiaca_Ataque == 1) %>% # vemos los que han tenido enfermedad cardiaca o ataque por sexo
      count(Enfermedad_Cardiaca_Ataque) %>% 
      mutate(Sexo = ifelse(Sexo == 1, "Hombre", "Mujer")) %>%
      ungroup() %>% 
      arrange(factor(Edad))

datos3 %>% plot_ly(x = ~Edad, y = ~n, type = 'bar',color = ~ factor(Sexo), colors = colores) %>% 
      layout(xaxis = list(title = "Edades"),
             yaxis = list(title = "Cantidad de enfermedades cardiacas")) %>% 
      config(displayModeBar = FALSE)


datos4 <- datos2 %>% 
  group_by(Edad, Sexo, Fumador) %>% 
  filter(Enfermedad_Cardiaca_Ataque == 1) %>% # vemos los que han tenido enfermedad cardiaca o ataque por sexo y fumador
  count(Enfermedad_Cardiaca_Ataque) %>% 
  mutate(Sexo = ifelse(Sexo == 1, "Hombre", "Mujer")) %>%
  mutate(Fumador = ifelse(Fumador == 1, "Fumador", "No Fumador")) %>%
  ungroup() %>% 
  arrange(factor(Edad))

datos4 %>% 
  ggplot(aes(x = Edad, y = n, fill = factor(Sexo))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Fumador) +
  labs(x = "Edades", y = "Cantidad de enfermedades cardiacas") +
  scale_fill_manual(values = colores) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = -35, hjust = 1))
```

Ahora mostramos en una tabla las variables del gráfico anterior sin contar la edad

```{r}
library(DT)
datos2 %>% 
  group_by(Sexo, Fumador, Colesterol_Alto, Diabetes) %>% 
  mutate(Sexo = ifelse(Sexo == 1, "Hombre", "Mujer")) %>%
  mutate(Fumador = ifelse(Fumador == 1, "Fumador", "No Fumador")) %>% 
  mutate(Colesterol_Alto = ifelse(Fumador == 1, "Colesterol alto", "No coresterol alto")) %>% 
  
  summarize(media_ataques = round(mean(Enfermedad_Cardiaca_Ataque),2)) %>% DT::datatable(extensions = 'Buttons', 
               options = list(dom = 'Blfrtip', 
                              buttons = c('copy', 'csv', 'excel', 'pdf', 'print'), 
                              pageLength = 5, autoWidth = TRUE ))
```


# 2. Validación para medir la predictividad del modelo

Para empezar a trabajar con nuestros datos, vamos a dividirlos en validación y entrenamiento. Y generaremos nuestro modelo a partir de los datos almacenados en la variable entrenamiento y lo comprobaremos con los datos almacenados en la variable test.

```{r}

set.seed(12345)

# Establecemos el porcentaje de observaciones para el conjunto de entrenamiento y prueba
porcentaje_entrenamiento <- 0.7

# Obtenemos el número de observaciones para el entrenamiento
observaciones <- round(porcentaje_entrenamiento * nrow(data)) 

seleccion <- sample(nrow(data), observaciones)
entrenamiento <- datos[seleccion,]          # Conjunto de entrenamiento
test <- datos[-seleccion,]                  # Conjunto de validación
```

Lo primero que haremos será comprobar la capacidad de predicción del modelo lineal.

Como variable respuesta tenemos: Enfermedad_Cardiaca_Ataque

Ya que nos interesa saber de que depende este evento, por ello usamos 
el resto de variables como predictoras. Estimamos los modelos usando el conjunto de datos del banco de entrenamiento.


```{r}
ajuste <- glm(Enfermedad_Cardiaca_Ataque ~ ., family = "binomial",data=entrenamiento)
```
Ahora vamos a elegir las variables que mejor que ajustan segun su AIC

```{r,  eval = FALSE}
step(ajuste)
```


```{r}
ajuste_bueno <- glm(Enfermedad_Cardiaca_Ataque ~ Presion_Sanginea_Alta + Colesterol_Alto + 
    Control_Colesterol + Fumador + Ataque + Diabetes + Actividad_Fisica + 
    Verduras + Consumo_Alcohol + No_Doctor_Caro + Salud_General + 
    Salud_Mental + Dificultad_Andar + Sexo + Edad + Educacion + 
    Ingreso, family = "binomial", data = entrenamiento)
summary(ajuste_bueno)
```

En este caso podemos ver que la formula de regresion quedaria tal que:

Enfermedad_Cardiaca_Ataque = b0 + b1Presion_Sanginea_Alta + b2Colesterol_Alto + b3Fumador + b4Ataque + b5Diabetes + b6Salud_General + b7Salud_Fisica + b8Dificultad_Andar + b9Ingreso.




```{r}
prediccion <- predict(ajuste_bueno,test)
```


# CURVA ROC

```{r}
library(pROC)
par.roc <- roc(test$Enfermedad_Cardiaca_Ataque, prediccion)
par.roc
plot(par.roc)



```


```{r}
library(ResourceSelection)
hoslem.test(entrenamiento$Enfermedad_Cardiaca_Ataque, fitted(ajuste_bueno), g = 8)
```

Como podemos observar en el resultado del test, tenemos un p-valor muy pequeño(p-valor = 2.2e-16), con lo que podemos concluir que  rechazamos nuestra hipotesis nula lo cual significaria que los datos no se ajustan al modelo.
El problema es la asumcion de probabilidad incremental en forma de inversa logistica. Nuestras variables parecen que no se relacionan linealmente con el logit de la probabilidad. 



